let eyetracker={};$(document).ready(function(){eyetracker={errorState:!1,isRunning:!1,studyStarted:!1,isCalibrated:!1,isEyeFixing:!1,errorMessageTimeout:null,calibrationPointsTotalCounter:0,calibrationPointCountLimit:1,calibrationPointSize:20,calibrationPoints:[],destroyPoints:[],destroyPointSize:50,globalClock:0,globalItemClock:0,currentItem:0,data:{recordClick:!1,faceTrackerData:null,mouseX:0,mouseY:0,tempItemData:[],calibrationOffset:{x:0,y:0,distance:0}},website:{config:{recordingWidth:1680,recordingFPS:10},isReady:!1,isRecording:!1,stream:null,mediaRecorder:null,recordedChunks:null},quality:{init:!1,lostTimer:null,eyesPosition:{left:{x:null,y:null,minX:999999,maxX:null,minY:999999,maxY:null},right:{x:null,y:null,minX:999999,maxX:null,minY:999999,maxY:null}},face:{visible:!1,position:{x:null,y:null}},headMovementsCounter:0},study:{id:null,config:{survey:!1,separator:!1},items:[]},tester:{id:null},prepare:function(){eyetracker.helpers.checkBrowser(),eyetracker.errorState||eyetracker.connect()},connect:function(){return webgazer.setRegression("threadedRidge").setGazeListener(eyetracker.helpers.onEyetrackingData).showPredictionPoints(!1).begin(),setTimeout(function(){eyetracker.load()},100),eyetracker.errorMessageTimeout=setTimeout(function(){eyetracker.ui.elements.webcamCameraAccess.find("#webcamCameraAccess-error").show()},4e3),{}},load:function(){webgazer.isReady()?(clearTimeout(eyetracker.errorMessageTimeout),eyetracker.ui.setupTracking()):setTimeout(function(){eyetracker.load()},100)},ui:{elements:{webcamCameraAccess:$("#webcamCameraAccess"),calibrationPoint:$("#calibrationPoint"),webcamCalibration:$("#webcamCalibration"),webcamReCalibration:$("#reCalibration"),webcamReturnToPosition:$("#webcamReturnToPosition"),itemVideoYtContainer:$("#itemVideoYtContainer"),videoYTPlayer:null,websiteWindow:null,websiteWindowStateInterval:null,websiteWindowUrl:null,websiteWindowFixCalibration:null,websiteWindowFixCalibrationStateInterval:null,websiteWindowFixCalibrationUrl:null,websiteWindowPopupsConfirmUrl:null,muteSound:$("#muteSound"),itemSeparator:{element:$("#itemSeparatorHolder"),hide:function(){this.element.hide()},showText:function(e){this.element.find("#itemSeparator").html(e),this.element.find("#itemSeparatorButton").hide(),this.element.show()},showInstruction:function(e,t){this.element.find("#itemSeparator").html(e),this.element.find("#itemSeparatorButton").show(),this.element.find("#itemSeparatorButton").off("click"),this.element.find("#itemSeparatorButton").on("click",t),this.element.show()},showWebsiteInstruction:function(e,t){this.element.find("#itemSeparator").html(e),this.element.find("#itemSeparatorButton").show(),this.element.find("#itemSeparatorButton").removeClass("btn-cta-primary"),this.element.find("#itemSeparatorButton").html(appTranslate("info_screen_sharing_finished_early")),this.element.find("#itemSeparatorButton").off("click"),this.element.find("#itemSeparatorButton").on("click",t),this.element.show()},showPoint:function(){this.element.find("#itemSeparator").html('<i class="fa fa-compress"></i>'),this.element.find("#itemSeparatorButton").hide(),this.element.show()},showRelax:function(){this.element.find("#itemSeparator").html(""),this.element.find("#itemSeparatorButton").hide(),this.element.show()}},item:$(".studyItem"),gazePoint:{history:[],element:$("#gazePoint"),x:0,y:0,size:8,show:function(){this.element.show()},move:function(){this.element.css("left",this.x-this.size/2+"px"),this.element.css("top",this.y-this.size/2+"px")},hide:function(){this.element.fadeOut(1e3)}},countdown:{element:$("#countDown"),start:function(){let e=this,t=3;this.element.find("span").html(t),this.element.show();let i=setInterval(function(){t--,e.element.find("span").html(t),0===t&&(e.element.hide(),clearInterval(i))},1e3)}},loader:{element:$("#loadingCover"),show:function(){this.element.show()},hide:function(){this.element.hide()}},burst:{effect1:new mojs.Burst({left:0,top:0,count:5,radius:{50:150},children:{fill:"white",shape:"line",stroke:["#FFFFFF","#A50710"],strokeWidth:12,radius:"rand(30, 60)",radiusY:0,scale:{1:0},pathScale:"rand(.5, 1)",degreeShift:"rand(-360, 360)",isForce3d:!0}}),effect2:new mojs.Burst({top:0,left:0,count:3,radius:{0:150},children:{shape:["circle","rect"],points:5,fill:["#EAEAEA","#A50710"],radius:"rand(30, 60)",scale:{1:0},pathScale:"rand(.5, 1)",isForce3d:!0}}),effect3:new mojs.Shape({left:0,top:0,fill:"#EAEAEA",scale:{.2:1},opacity:{1:0},isForce3d:!0,isShowEnd:!1,radius:100}),effect4:new mojs.Shape({left:0,top:0,fill:"#EAEAEA",scale:{.2:1},opacity:{1:0},isForce3d:!0,isShowEnd:!1,radius:150,easing:"cubic.out",delay:50}),run:function(e,t){eyetracker.ui.elements.burst.effect1.tune({x:e,y:t}).generate().replay(),eyetracker.ui.elements.burst.effect2.tune({x:e,y:t}).generate().replay(),eyetracker.ui.elements.burst.effect3.tune({x:e,y:t}).replay(),eyetracker.ui.elements.burst.effect4.tune({x:e,y:t}).replay()}}},openWebsiteWindowModal:function(){navigator.userAgent.match(/Chrome/i)&&!navigator.userAgent.match(/OPR/i)?$("#modal-allow-screen-sharing").modal({backdrop:"static",keyboard:!1}):$("#modal-allow-screen-sharing-ff").modal({backdrop:"static",keyboard:!1})},openWebsiteWindow:async function(){eyetracker.ui.closeFullscreen(),eyetracker.helpers.sleep(1e3);try{eyetracker.website.stream=await navigator.mediaDevices.getDisplayMedia({video:{width:eyetracker.website.config.recordingWidth,resizeMode:"crop-and-scale",frameRate:eyetracker.website.config.recordingFPS,cursor:"always"},audio:!1}),eyetracker.ui.elements.websiteWindow=window.open(eyetracker.ui.elements.websiteWindowUrl,"_blank"),eyetracker.ui.elements.websiteWindowStateInterval=setInterval(function(){eyetracker.ui.elements.websiteWindow.closed&&eyetracker.website.isReady&&(clearInterval(eyetracker.ui.elements.websiteWindowStateInterval),window.location.href="failed/?reason="+appTranslate("info_screen_sharing_closed_tab"))},250),eyetracker.website.isReady=!0,eyetracker.website.recordedChunks=[],eyetracker.website.mediaRecorder=new MediaRecorder(eyetracker.website.stream,{mimeType:"video/webm"}),eyetracker.website.mediaRecorder.ondataavailable=function(e){eyetracker.website.recordedChunks.push(e.data),eyetracker.flow.finishStudy()},eyetracker.website.mediaRecorder.onstop=function(){eyetracker.website.isReady&&(eyetracker.website.isReady=!1,eyetracker.ui.elements.websiteWindow.close(),eyetracker.ui.elements.websiteWindowFixCalibration&&eyetracker.ui.elements.websiteWindowFixCalibration.close(),window.location.href="failed/?reason="+appTranslate("info_screen_sharing_stopped_recording"))}}catch(e){console.log(e),$("#modal-allow-screen-sharing-error").modal({backdrop:"static",keyboard:!1})}},uploadWebsiteVideo:function(e){eyetracker.ui.elements.loader.element.show();var t=new Blob(e,{type:"video/webm"});s3.upload({Key:"experiments/website/experiment_"+eyetracker.study.id+"/"+eyetracker.tester.id+".webm",Body:t,ACL:"public-read"},function(e,t){e&&reject("error"),eyetracker.ui.elements.loader.element.hide(),eyetracker.flow.showFormOrRedirect()}).on("httpUploadProgress",function(e){var t=parseInt(100*e.loaded/e.total);eyetracker.ui.elements.loader.element.find("#percent").html(t+"%")})},downloadWebsiteVideo:function(e){var t=new Blob(e,{type:"video/webm"}),i=URL.createObjectURL(t),r=document.createElement("a");document.body.appendChild(r),r.style="display: none",r.href=i,r.download="RealEye-recording-tester.webm",r.click(),window.URL.revokeObjectURL(i)},openFullscreen:function(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},closeFullscreen:function(){(window.fullScreen||window.innerHeight===screen.height)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())},setCoordinates:function(){$(".item-click-coordinates").each(function(){var e=$(this),t=e.data("coords");if(e.data("scrolling")){i=window.outerWidth/e.data("item-width");e.css("left",t[0]*i),e.css("top",t[1]*i),e.css("width",(t[2]-t[0])*i),e.css("height",(t[3]-t[1])*i)}else{if(window.outerWidth/window.innerHeight<e.data("item-width")/e.data("item-height")){var i=window.innerWidth/e.data("item-width");t[0]=t[0]*i,t[1]=t[1]*i+(window.innerHeight-e.data("item-height")*i)/2,t[2]=t[2]*i,t[3]=t[3]*i+(window.innerHeight-e.data("item-height")*i)/2}else{var i=window.innerHeight/e.data("item-height");t[0]=t[0]*i+(window.innerWidth-e.data("item-width")*i)/2,t[1]=t[1]*i,t[2]=t[2]*i+(window.innerWidth-e.data("item-width")*i)/2,t[3]=t[3]*i}e.css("left",t[0]),e.css("top",t[1]),e.css("width",t[2]-t[0]),e.css("height",t[3]-t[1])}})},setCalibrationPoints:function(){eyetracker.calibrationPoints=[[window.innerWidth/2,window.innerHeight/2],[5*eyetracker.calibrationPointSize/2,5*eyetracker.calibrationPointSize/2],[window.innerWidth/2,5*eyetracker.calibrationPointSize/2],[window.innerWidth-5*eyetracker.calibrationPointSize/2,5*eyetracker.calibrationPointSize/2],[window.innerWidth-5*eyetracker.calibrationPointSize/2,window.innerHeight/2],[window.innerWidth-5*eyetracker.calibrationPointSize/2,window.innerHeight-5*eyetracker.calibrationPointSize/2],[window.innerWidth/2,window.innerHeight-5*eyetracker.calibrationPointSize/2],[5*eyetracker.calibrationPointSize/2,window.innerHeight-5*eyetracker.calibrationPointSize/2],[5*eyetracker.calibrationPointSize/2,window.innerHeight/2],[window.innerWidth/4,window.innerHeight/2],[window.innerWidth/2,window.innerHeight/4],[3*window.innerWidth/4,window.innerHeight/2],[window.innerWidth/2,3*window.innerHeight/4],[window.innerWidth/2,window.innerHeight/2],[1*window.innerWidth/10,1*window.innerHeight/8],[1*window.innerWidth/10,7*window.innerHeight/8],[9*window.innerWidth/10,1*window.innerHeight/8],[9*window.innerWidth/10,7*window.innerHeight/8],[window.innerWidth/6,window.innerHeight/2],[window.innerWidth/2,window.innerHeight/6],[5*window.innerWidth/6,window.innerHeight/2],[window.innerWidth/2,5*window.innerHeight/6],[window.innerWidth/2,window.innerHeight/2],[5*eyetracker.calibrationPointSize/2,5*eyetracker.calibrationPointSize/2],[5*eyetracker.calibrationPointSize/2,window.innerHeight/2],[window.innerWidth/2,5*eyetracker.calibrationPointSize/2],[5*eyetracker.calibrationPointSize/2,window.innerHeight-5*eyetracker.calibrationPointSize/2],[window.innerWidth-5*eyetracker.calibrationPointSize/2,5*eyetracker.calibrationPointSize/2],[window.innerWidth/2,window.innerHeight-5*eyetracker.calibrationPointSize/2],[window.innerWidth-5*eyetracker.calibrationPointSize/2,window.innerHeight/2],[window.innerWidth-5*eyetracker.calibrationPointSize/2,window.innerHeight-5*eyetracker.calibrationPointSize/2],[window.innerWidth/4,window.innerHeight/2],[window.innerWidth/2,window.innerHeight/4],[3*window.innerWidth/4,window.innerHeight/2],[window.innerWidth/2,3*window.innerHeight/4],[1*window.innerWidth/6,1*window.innerHeight/6],[1*window.innerWidth/6,5*window.innerHeight/6],[5*window.innerWidth/6,1*window.innerHeight/6],[5*window.innerWidth/6,5*window.innerHeight/6],[window.innerWidth/2,window.innerHeight/2]]},setDebugCalibrationPoints:function(){eyetracker.calibrationPoints=[[window.innerWidth/2,window.innerHeight/2],[1*window.innerWidth/10,1*window.innerHeight/10],[1*window.innerWidth/10,9*window.innerHeight/10],[9*window.innerWidth/10,1*window.innerHeight/10],[9*window.innerWidth/10,9*window.innerHeight/10]]},setDestroyPoints:function(){eyetracker.destroyPoints=[[1*window.innerWidth/10,1*window.innerHeight/8],[1*window.innerWidth/10,7*window.innerHeight/8],[9*window.innerWidth/10,1*window.innerHeight/8],[9*window.innerWidth/10,7*window.innerHeight/8],[window.innerWidth/4,window.innerHeight/2],[window.innerWidth/2,window.innerHeight/4],[3*window.innerWidth/4,window.innerHeight/2],[window.innerWidth/2,3*window.innerHeight/4]]},setDebugDestroyPoints:function(){eyetracker.destroyPoints=[[window.innerWidth/2,window.innerHeight/2]]},drawCalibrationPoint:function(e,t){eyetracker.ui.elements.calibrationPoint.css("left",e),eyetracker.ui.elements.calibrationPoint.css("top",t),eyetracker.ui.elements.calibrationPoint.css("display","block");let i=Math.floor(eyetracker.calibrationPointsTotalCounter/eyetracker.calibrationPointCountLimit);eyetracker.ui.elements.calibrationPoint.html(eyetracker.calibrationPoints.length-i)},prepareYTVideo:function(e){eyetracker.ui.elements.itemVideoYtContainer.find("#itemVideoYt").YTPlayer({fitToBackground:!1,videoId:e,pauseOnScroll:!1,origin:window.location.origin,repeat:!1,playerVars:{modestbranding:0,autoplay:1,controls:0,showinfo:0,branding:0,rel:0,autohide:0},callback:function(){eyetracker.ui.elements.videoYTPlayer=eyetracker.ui.elements.itemVideoYtContainer.find("#itemVideoYt").data("ytPlayer").player}})},setupTracking:function(){"video-yt"===eyetracker.study.type&&eyetracker.ui.prepareYTVideo(eyetracker.study.items[0].youtubeId),$("#run-calibration-trigger").on("click",function(){eyetracker.ui.openFullscreen(document.documentElement),eyetracker.ui.elements.webcamCameraAccess.hide(),eyetracker.ui.elements.webcamCalibration.show(),setTimeout(function(){eyetracker.studyStarted=!0,$("#browser-width").val(window.innerWidth),$("#browser-height").val(window.innerHeight),window.location.href.indexOf("debug")>-1?(eyetracker.ui.setDebugCalibrationPoints(),eyetracker.ui.setDebugDestroyPoints()):(eyetracker.ui.setCalibrationPoints(),eyetracker.ui.setDestroyPoints()),eyetracker.ui.setCoordinates(),eyetracker.ui.elements.calibrationPoint.show(),"undefined"!=typeof showGazePoint&&!0===showGazePoint&&eyetracker.ui.elements.gazePoint.show()},2e3)}),eyetracker.ui.elements.calibrationPoint.on("mouseover",function(){eyetracker.ui.elements.webcamCalibration.find("#webcamCalibration-instructions").fadeOut(),eyetracker.ui.elements.webcamCalibration.find("#webcamCalibration-instructions").fadeOut();let e=Math.floor(eyetracker.calibrationPointsTotalCounter/eyetracker.calibrationPointCountLimit);webgazer.recordScreenPosition(eyetracker.calibrationPoints[e][0],eyetracker.calibrationPoints[e][1],"click"),faceTrackerData.left.x>0&&(eyetracker.quality.eyesPosition.left.minX=Math.min(eyetracker.quality.eyesPosition.left.minX,faceTrackerData.left.x)),faceTrackerData.left.y>0&&(eyetracker.quality.eyesPosition.left.minY=Math.min(eyetracker.quality.eyesPosition.left.minY,faceTrackerData.left.y)),eyetracker.quality.eyesPosition.left.maxX=Math.max(eyetracker.quality.eyesPosition.left.maxX,faceTrackerData.left.x),eyetracker.quality.eyesPosition.left.maxY=Math.max(eyetracker.quality.eyesPosition.left.maxY,faceTrackerData.left.y),faceTrackerData.right.x>0&&(eyetracker.quality.eyesPosition.right.minX=Math.min(eyetracker.quality.eyesPosition.right.minX,faceTrackerData.right.x)),faceTrackerData.right.y>0&&(eyetracker.quality.eyesPosition.right.minY=Math.min(eyetracker.quality.eyesPosition.right.minY,faceTrackerData.right.y)),eyetracker.quality.eyesPosition.right.maxX=Math.max(eyetracker.quality.eyesPosition.right.maxX,faceTrackerData.right.x),eyetracker.quality.eyesPosition.right.maxY=Math.max(eyetracker.quality.eyesPosition.right.maxY,faceTrackerData.right.y),eyetracker.ui.elements.burst.run(eyetracker.calibrationPoints[e][0],eyetracker.calibrationPoints[e][1]),eyetracker.calibrationPointsTotalCounter++,(e=Math.floor(eyetracker.calibrationPointsTotalCounter/eyetracker.calibrationPointCountLimit))>=eyetracker.calibrationPoints.length?(eyetracker.ui.elements.webcamCalibration.find("#calibrationPoint").hide(),eyetracker.flow.calibrationCheck.start()):eyetracker.calibrationPointsTotalCounter%eyetracker.calibrationPointCountLimit==0&&eyetracker.ui.drawCalibrationPoint(eyetracker.calibrationPoints[e][0],eyetracker.calibrationPoints[e][1])}),$("#modal-run-calibration").modal({backdrop:"static",keyboard:!1})}},flow:{timers:{showItem:null},calibrationCheck:{hasStarted:!1,calibrationCheckTimer:null,restartTimer:function(){clearTimeout(eyetracker.flow.calibrationCheck.calibrationCheckTimer),eyetracker.flow.calibrationCheck.calibrationCheckTimer=setTimeout(function(){eyetracker.ui.elements.webcamCalibration.hide(),eyetracker.flow.calibrationCheck.hasStarted=!1,$("#modal-webcam-calibration-issue").modal({backdrop:"static",keyboard:!1})},3e3)},start:function(){eyetracker.ui.elements.webcamCalibration.find("#webcamCalibration-confirmation").fadeIn(),$.each(eyetracker.destroyPoints,function(e,t){$("<div/>",{class:"destructionPoint","data-counter":0,css:{top:t[1]+"px",left:t[0]+"px"}}).appendTo("body")}),eyetracker.flow.calibrationCheck.hasStarted=!0,eyetracker.flow.calibrationCheck.restartTimer()},check:function(){eyetracker.flow.calibrationCheck.hasStarted&&!eyetracker.isCalibrated&&($(".destructionPoint").length>0?$.each($(".destructionPoint"),function(e,t){if(eyetracker.helpers.isPointAround(eyetracker.ui.elements.gazePoint.x,eyetracker.ui.elements.gazePoint.y,parseInt($(t).css("left")),parseInt($(t).css("top")),150))if($(this).data("counter")>=10)eyetracker.ui.elements.burst.run(parseInt($(t).css("left")),parseInt($(t).css("top"))),$(t).remove();else{eyetracker.flow.calibrationCheck.restartTimer(),$(this).data("counter",$(this).data("counter")+1);var i=50+3*$(this).data("counter");$(this).css("width",i+"px"),$(this).css("height",i+"px"),$(this).css("margin-top",-1*i/2+"px"),$(this).css("margin-left",-1*i/2+"px")}}):(clearTimeout(eyetracker.flow.calibrationCheck.calibrationCheckTimer),eyetracker.isCalibrated=!0,"undefined"!=typeof showGazePoint&&!1!==showGazePoint||eyetracker.ui.elements.gazePoint.hide(),eyetracker.ui.elements.webcamCalibration.hide(),eyetracker.flow.startStudy()))}},calibrationReCheck:{hasStarted:!1,calibrationReCheckTimer:null,restartTimer:function(){clearTimeout(eyetracker.flow.calibrationReCheck.calibrationReCheckTimer),eyetracker.flow.calibrationReCheck.calibrationReCheckTimer=setTimeout(function(){eyetracker.ui.elements.webcamCalibration.hide(),eyetracker.flow.calibrationReCheck.hasStarted=!1,eyetracker.flow.endStudy(),$("#calibration-failed").val(1),""==$("#calibration-failed-reason").val()&&$("#calibration-failed-reason").val("Calibration check failed at the end")},3e3)},start:function(){eyetracker.ui.elements.webcamCalibration.show(),eyetracker.ui.elements.webcamCalibration.find("#webcamCalibration-confirmation").fadeIn(),$.each(eyetracker.destroyPoints,function(e,t){$("<div/>",{class:"destructionPoint","data-counter":0,css:{top:t[1]+"px",left:t[0]+"px"}}).appendTo("body")}),eyetracker.flow.calibrationReCheck.hasStarted=!0,eyetracker.flow.calibrationReCheck.restartTimer()},check:function(){eyetracker.flow.calibrationReCheck.hasStarted&&eyetracker.isCalibrated&&($(".destructionPoint").length>0?$.each($(".destructionPoint"),function(e,t){if(eyetracker.helpers.isPointAround(eyetracker.ui.elements.gazePoint.x,eyetracker.ui.elements.gazePoint.y,parseInt($(t).css("left")),parseInt($(t).css("top")),150))if($(this).data("counter")>=10)eyetracker.ui.elements.burst.run(parseInt($(t).css("left")),parseInt($(t).css("top"))),$(t).remove();else{eyetracker.flow.calibrationReCheck.restartTimer(),$(this).data("counter",$(this).data("counter")+1);var i=50+3*$(this).data("counter");$(this).css("width",i+"px"),$(this).css("height",i+"px"),$(this).css("margin-top",-1*i/2+"px"),$(this).css("margin-left",-1*i/2+"px")}}):(clearTimeout(eyetracker.flow.calibrationReCheck.calibrationReCheckTimer),eyetracker.flow.calibrationReCheck.hasStarted=!1,eyetracker.ui.elements.webcamCalibration.hide(),eyetracker.flow.endStudy()))}},startStudy:function(){var e;eyetracker.study.config.instruction?e=eyetracker.study.config.instruction:("images"===eyetracker.study.type&&(e=appTranslate("instruction_study_execution"),eyetracker.helpers.isScrollingForStudy()&&(e=e+" "+appTranslate("instruction_study_execution_scroll"))),"video-yt"===eyetracker.study.type&&(e=appTranslate("instruction_study_execution_video"))),"website"===eyetracker.study.type?(eyetracker.helpers.playMuteSound(),eyetracker.ui.openWebsiteWindowModal(),eyetracker.ui.elements.itemSeparator.showWebsiteInstruction(e,function(){clearTimeout(eyetracker.flow.timers.showItem),eyetracker.flow.hideItemWebsite()})):eyetracker.ui.elements.itemSeparator.showInstruction(e,eyetracker.flow.confirmStudyInstructions)},confirmStudyInstructions:function(){eyetracker.ui.elements.countdown.element.show(),eyetracker.ui.elements.countdown.start(),$("#calibration-offset-before").val(JSON.stringify(eyetracker.data.calibrationOffset)),setTimeout(function(){eyetracker.isRunning=!0,eyetracker.flow.showItem()},3e3)},confirmItemInstructions:function(){"video-yt"===eyetracker.study.type&&eyetracker.flow.showItemVideoYT(),"images"===eyetracker.study.type&&eyetracker.flow.showItemImage()},showItem:function(){eyetracker.study.items[eyetracker.currentItem].text?eyetracker.ui.elements.itemSeparator.showInstruction(eyetracker.study.items[eyetracker.currentItem].text,eyetracker.flow.confirmItemInstructions):("video-yt"===eyetracker.study.type&&eyetracker.flow.showItemVideoYT(),"images"===eyetracker.study.type&&eyetracker.flow.showItemImage())},showItemWebsite:function(){eyetracker.data.tempItemData=[],eyetracker.globalItemClock=eyetracker.globalClock,eyetracker.website.isRecording=!0,eyetracker.website.mediaRecorder.start(),eyetracker.flow.timers.showItem=setTimeout(function(){eyetracker.flow.hideItemWebsite()},eyetracker.study.items[eyetracker.currentItem].stimuliTime)},hideItemWebsite:function(){if(eyetracker.website.isRecording=!1,eyetracker.website.isReady=!1,eyetracker.ui.elements.websiteWindow.close(),eyetracker.ui.elements.websiteWindowFixCalibration&&eyetracker.ui.elements.websiteWindowFixCalibration.close(),eyetracker.ui.elements.itemSeparator.hide(),$("#item-"+eyetracker.study.items[eyetracker.currentItem].id+"-data").val(JSON.stringify(eyetracker.data.tempItemData)),eyetracker.study.items[eyetracker.currentItem].questionEnabled)eyetracker.flow.showItemQuestion();else{eyetracker.website.stream.getTracks().forEach(e=>e.stop()),eyetracker.website.mediaRecorder.stop()}},showItemVideoYT:function(){eyetracker.data.tempItemData=[],eyetracker.globalItemClock=eyetracker.globalClock,eyetracker.ui.elements.videoYTPlayer.seekTo(0),eyetracker.ui.elements.videoYTPlayer.unMute(),eyetracker.ui.elements.itemVideoYtContainer.css("visibility","visible"),eyetracker.ui.elements.itemSeparator.hide(),eyetracker.flow.timers.showItem=setTimeout(function(){eyetracker.flow.hideItemVideoYT()},eyetracker.study.items[eyetracker.currentItem].stimuliTime)},hideItemVideoYT:function(){eyetracker.ui.elements.itemVideoYtContainer.hide(),eyetracker.ui.elements.videoYTPlayer.stopVideo(),$("#item-"+eyetracker.study.items[eyetracker.currentItem].id+"-data").val(JSON.stringify(eyetracker.data.tempItemData)),eyetracker.study.items[eyetracker.currentItem].questionEnabled?eyetracker.flow.showItemQuestion():(eyetracker.currentItem++,eyetracker.currentItem>=eyetracker.study.items.length?eyetracker.flow.finishStudy():eyetracker.flow.showItemVideoYT())},showItemImage:function(){var e=eyetracker.ui.elements.item.filter("#item-"+eyetracker.study.items[eyetracker.currentItem].id);eyetracker.study.items[eyetracker.currentItem].scrolling?(e.height(Math.round(e.data("item-height")*window.innerWidth/e.data("item-width"))),e.css("background-size","cover"),$("body").css({"overflow-y":"auto"})):$("body").css({"overflow-y":"hidden"}),$(window).scrollTop(0),eyetracker.study.config.separator?(eyetracker.ui.elements.itemSeparator.showRelax(),setTimeout(function(){eyetracker.ui.elements.itemSeparator.showPoint(),setTimeout(function(){eyetracker.ui.elements.itemSeparator.hide(),eyetracker.data.tempItemData=[],eyetracker.globalItemClock=eyetracker.globalClock,e.show(),eyetracker.flow.timers.showItem=setTimeout(function(){eyetracker.flow.hideItem()},eyetracker.study.items[eyetracker.currentItem].stimuliTime)},eyetracker.study.items[eyetracker.currentItem].fixationTime)},eyetracker.study.items[eyetracker.currentItem].relaxationTime)):(eyetracker.ui.elements.itemSeparator.hide(),eyetracker.data.tempItemData=[],eyetracker.globalItemClock=eyetracker.globalClock,e.show(),eyetracker.flow.timers.showItem=setTimeout(function(){eyetracker.flow.hideItem()},eyetracker.study.items[eyetracker.currentItem].stimuliTime))},showItemQuestion:function(){if($("#item-question-form-question").html(eyetracker.study.items[eyetracker.currentItem].question.question),$("#item-question-form-single-list").html(""),$("#item-question-form-multiply-list").html(""),eyetracker.study.items[eyetracker.currentItem].question.multiply){$("#item-question-form-multiply-container").show(),$("#item-question-form-single-container").hide();var e=0;$.each(eyetracker.study.items[eyetracker.currentItem].question.answers,function(){$("#item-question-form-multiply-list").append($("#item-question-form-multiply-template").html()),$("#item-question-form-multiply-list").find("input").last().val(e),$("#item-question-form-multiply-list").find("input").last().attr("id","inp_"+e),$("#item-question-form-multiply-list").find("label").last().html(this),$("#item-question-form-multiply-list").find("label").last().attr("for","inp_"+e),e++})}else{$("#item-question-form-multiply-container").hide(),$("#item-question-form-single-container").show();e=0;$.each(eyetracker.study.items[eyetracker.currentItem].question.answers,function(){$("#item-question-form-single-list").append($("#item-question-form-single-template").html()),$("#item-question-form-single-list").find("input").last().val(e),$("#item-question-form-single-list").find("input").last().attr("id","inp_"+e),$("#item-question-form-single-list").find("label").last().html(this),$("#item-question-form-single-list").find("label").last().attr("for","inp_"+e),e++})}$("#modal-item-question").modal({backdrop:"static",keyboard:!1})},saveItemQuestion:function(){var e=[];if(eyetracker.study.items[eyetracker.currentItem].question.multiply?$.each($("#item-question-form-multiply-list").find("input"),function(){$(this).is(":checked")&&e.push($(this).val())}):$.each($("#item-question-form-single-list").find("input"),function(){$(this).is(":checked")&&e.push($(this).val())}),$("#modal-item-question").modal("hide"),$("#item-"+eyetracker.study.items[eyetracker.currentItem].id+"-answers").val(JSON.stringify(e)),"website"===eyetracker.study.type){eyetracker.website.stream.getTracks().forEach(e=>e.stop()),eyetracker.website.mediaRecorder.stop()}else eyetracker.currentItem++,eyetracker.currentItem>=eyetracker.study.items.length?eyetracker.flow.finishStudy():("images"===eyetracker.study.type&&eyetracker.flow.showItem(),"video-yt"===eyetracker.study.type&&eyetracker.flow.showItemVideoYT())},hideItem:function(){$(window).scrollTop(0),eyetracker.ui.elements.item.hide(),$("#item-"+eyetracker.study.items[eyetracker.currentItem].id+"-data").val(JSON.stringify(eyetracker.data.tempItemData)),eyetracker.study.items[eyetracker.currentItem].questionEnabled?eyetracker.flow.showItemQuestion():(eyetracker.currentItem++,eyetracker.currentItem>=eyetracker.study.items.length?eyetracker.flow.finishStudy():eyetracker.flow.showItem())},finishStudy:function(){$("#modal-run-calibration").modal("hide"),eyetracker.isRunning=!1,eyetracker.studyStarted=!1,$("#calibration-offset-after").val(JSON.stringify(eyetracker.data.calibrationOffset)),eyetracker.flow.endStudy()},endStudy:function(){eyetracker.ui.closeFullscreen(),webgazer.end(),"website"===eyetracker.study.type?eyetracker.ui.uploadWebsiteVideo(eyetracker.website.recordedChunks):eyetracker.flow.showFormOrRedirect()},showFormOrRedirect:function(){eyetracker.study.config.survey?$("#modal-finish-study").modal({backdrop:"static",keyboard:!1}):(eyetracker.ui.elements.itemSeparator.showText(appTranslate("app_please_wait")),$("#study-form").submit())}},helpers:{onEyetrackingData:function(e,t,i){if(eyetracker.globalClock=t,i&&(eyetracker.data.faceTrackerData=i,eyetracker.helpers.setAndCheckHeadMovement(i)),e&&i&&(i.faceVisible&&(eyetracker.ui.elements.gazePoint.x=e.x,eyetracker.ui.elements.gazePoint.y=e.y,eyetracker.ui.elements.gazePoint.move(),eyetracker.flow.calibrationCheck.check(),eyetracker.flow.calibrationReCheck.check()),eyetracker.isCalibrated&&eyetracker.studyStarted&&eyetracker.isRunning&&i.faceVisible&&!eyetracker.isEyeFixing)){var r=[],n=eyetracker.globalClock-eyetracker.globalItemClock;eyetracker.ui.elements.videoYTPlayer&&"video-yt"===eyetracker.study.config.type&&(n=1e3*eyetracker.ui.elements.videoYTPlayer.getCurrentTime()),r[0]=e.x,r[1]=e.y,r[2]=Math.round(n),r[3]=$(window).scrollTop()||$("body").scrollTop(),r[4]=eyetracker.data.mouseX,r[5]=eyetracker.data.mouseY,eyetracker.data.recordClick&&(r[6]=1),eyetracker.data.tempItemData.push(r),eyetracker.data.recordClick=!1}},fixEyesPosition:function(){"website"===eyetracker.study.type?!eyetracker.isEyeFixing&&eyetracker.website.isRecording&&(eyetracker.ui.elements.websiteWindowFixCalibration=window.open(eyetracker.ui.elements.websiteWindowFixCalibrationUrl,"Fix Calibration","toolbar=1,width="+window.screen.availWidth+",height="+window.screen.availHeight),eyetracker.ui.elements.websiteWindowFixCalibrationStateInterval=setInterval(function(){eyetracker.ui.elements.websiteWindowFixCalibration.closed&&(clearInterval(eyetracker.ui.elements.websiteWindowFixCalibrationStateInterval),eyetracker.isEyeFixing=!1)},250),eyetracker.isEyeFixing=!0):(eyetracker.isEyeFixing||($("#calibration-credits").hide(),$("#calibrationButtons").hide(),$("#calibrationHeader").hide(),$("#fixEyesPosition").show(),$("#eyeFixButtons").show(),$("#eyeFixHeader").show(),$("#fixEyesPosition").find(".eyeExpected.left").css({left:100*eyetracker.quality.eyesPosition.left.x/webcamWidth+"%",top:100*eyetracker.quality.eyesPosition.left.y/webcamHeight+"%"}),$("#fixEyesPosition").find(".eyeExpected.right").css({left:100*eyetracker.quality.eyesPosition.right.x/webcamWidth+"%",top:100*eyetracker.quality.eyesPosition.right.y/webcamHeight+"%"}),$("#modal-run-calibration").modal({backdrop:"static",keyboard:!1})),eyetracker.isEyeFixing=!0)},setAndCheckHeadMovement:function(e){eyetracker.studyStarted&&(eyetracker.quality.init||(eyetracker.quality.face.position.x=e.facePosition.x,eyetracker.quality.face.position.y=e.facePosition.y,eyetracker.quality.eyesPosition.left.x=e.left.x,eyetracker.quality.eyesPosition.left.y=e.left.y,eyetracker.quality.eyesPosition.right.x=e.right.x,eyetracker.quality.eyesPosition.right.y=e.right.y,eyetracker.quality.init=!0),eyetracker.quality.face.visible&&!e.faceVisible&&(eyetracker.quality.lostTimer=performance.now()),eyetracker.quality.face.visible=e.faceVisible,!eyetracker.quality.face.visible&&performance.now()-eyetracker.quality.lostTimer>500?eyetracker.isCalibrated?($("#calibration-failed").val(1),""==$("#calibration-failed-reason").val()&&$("#calibration-failed-reason").val("Face was lost for over 500 ms"),eyetracker.helpers.fixEyesPosition()):eyetracker.ui.elements.webcamReCalibration.show():eyetracker.isCalibrated&&(e.left.x<.93*eyetracker.quality.eyesPosition.left.minX||e.left.y<.93*eyetracker.quality.eyesPosition.left.minY||e.left.x>1.07*eyetracker.quality.eyesPosition.left.maxX||e.left.y>1.07*eyetracker.quality.eyesPosition.left.maxY||e.right.x<.93*eyetracker.quality.eyesPosition.right.minX||e.right.y<.93*eyetracker.quality.eyesPosition.right.minY||e.right.x>1.07*eyetracker.quality.eyesPosition.right.maxX||e.right.y>1.07*eyetracker.quality.eyesPosition.right.maxY?(eyetracker.quality.headMovementsCounter++,eyetracker.quality.headMovementsCounter>10&&($("#calibration-failed").val(1),""==$("#calibration-failed-reason").val()&&$("#calibration-failed-reason").val("Many head movements"),eyetracker.helpers.fixEyesPosition())):eyetracker.quality.headMovementsCounter=0))},enablePopups:function(){let e=window.open(eyetracker.ui.elements.websiteWindowPopupsConfirmUrl,"_blank");null==e||void 0===e?navigator.userAgent.match(/Chrome/i)&&!navigator.userAgent.match(/OPR/i)?$("#modal-webcam-popup-request").modal({backdrop:"static",keyboard:!1}):$("#modal-webcam-popup-request-ff").modal({backdrop:"static",keyboard:!1}):eyetracker.prepare()},enablePopupsConfirm:function(){$("#modal-webcam-popup-request").modal("hide")},onMouseUpdate:function(e){eyetracker.data.mouseX=e.pageX,eyetracker.data.mouseY=e.pageY-window.pageYOffset},isPointAround:function(e,t,i,r,n){return e>=i-n&&e<=i+n&&t>=r-n&&t<=r+n},checkBrowser:function(){var e=!1;eyetracker.helpers.isMobile()&&(e=!0),eyetracker.helpers.isCompatibleBrowser()||(e=!0),window.innerWidth<window.innerHeight&&(e=!0),window.innerWidth<1024&&(e=!0),e&&($("#modal-test-prepare-issues").modal({backdrop:"static",keyboard:!1}),eyetracker.errorState=!0)},isMobile:function(){return!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))},isCompatibleBrowser:function(){return!((!navigator.userAgent.match(/Chrome/i)||navigator.userAgent.match(/OPR/i)||navigator.userAgent.match(/Edge/i))&&!navigator.userAgent.match(/Firefox/i))},isScrollingForStudy:function(){for(var e=0;e<eyetracker.study.items.length;e++)if(eyetracker.study.items[e].scrolling)return!0;return!1},playMuteSound:function(){eyetracker.ui.elements.muteSound.get(0).volume=.2,eyetracker.ui.elements.muteSound.get(0).play()},sleep:function(e){for(var t=(new Date).getTime();(new Date).getTime()<t+e;);}}},$(".form-validate").validate({submitHandler:function(e){$(e).find("button").attr("disabled","disabled"),e.submit()}}),$(".item-click-coordinates").click(function(){recordClick=!0,setTimeout(function(){clearTimeout(eyetracker.flow.timers.showItem),eyetracker.flow.hideItem()},300)}),$(".studyItem").click(function(){eyetracker.data.recordClick=!0}),document.addEventListener("mousemove",eyetracker.helpers.onMouseUpdate,!1),document.addEventListener("mouseenter",eyetracker.helpers.onMouseUpdate,!1),$("body").keyup(function(e){32==e.keyCode&&eyetracker.ui.elements.calibrationPoint.click()}),$(document).bind("contextmenu",function(e){return!1}),$("#modal-run-calibration").on("hidden.bs.modal",function(e){eyetracker.isEyeFixing=!1})}),window.showItemWebsite=function(){eyetracker.isRunning=!0,eyetracker.flow.showItemWebsite()},window.initWebsiteFixCalibration=function(){return[eyetracker.quality.eyesPosition.left.x,eyetracker.quality.eyesPosition.left.y,eyetracker.quality.eyesPosition.right.x,eyetracker.quality.eyesPosition.right.y]},window.enablePopupsConfirm=function(){eyetracker.helpers.enablePopupsConfirm()},$(window).resize(function(){if(eyetracker.studyStarted&&"website"!==eyetracker.study.type){let e="failed/?reason="+appTranslate("info_window_changed_size");"undefined"!=typeof showGazePoint&&!0===showGazePoint&&(e+="&showGazePoint=1"),window.location.href=e}}),$(window).onbeforeunload=function(){webgazer.end(),window.localStorage.clear()};